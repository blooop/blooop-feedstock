name: Release Workflow

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      package:
        description: 'Specific package to update (leave empty for all)'
        required: false
        type: string
      version:
        description: 'Specific version to build (leave empty to use API)'
        required: false
        type: string
      force_build:
        description: 'Force build even if no updates found'
        required: false
        type: boolean
        default: false
      force_overwrite:
        description: 'Force overwrite existing assets on upload'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'  # Trigger on version tags
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write
  id-token: write  # Required for trusted publishing with OIDC

jobs:
  # =============================================================================
  # Phase 1: Check for updates and generate build matrix
  # =============================================================================
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-updates: ${{ steps.set-matrix.outputs.has-updates }}
      packages: ${{ steps.set-matrix.outputs.packages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest

      - name: Update pixi lock file if needed
        run: |
          echo "Checking if pixi.lock is up to date..."
          if ! pixi install --locked 2>&1 | grep -q "up-to-date"; then
            echo "Lock file out of date, updating..."
            pixi install

            if git diff --quiet pixi.lock; then
              echo "Lock file is now up to date (no changes needed)"
            else
              echo "Lock file updated, committing changes..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add pixi.lock
              git commit -m "chore: update pixi.lock file [skip ci]"
              git push
              echo "Lock file committed and pushed"
            fi
          else
            echo "Lock file is already up to date"
          fi

      - name: Check for updates
        id: check
        run: |
          # Create array of packages that need updates
          UPDATES="[]"

          # Check claude-shim (shim doesn't auto-update version, only force_build triggers it)
          if [ -d "recipes/claude-shim" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "claude-shim" ]); then
            echo "Checking claude-shim..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/claude-shim/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # claude-shim is versioned independently - only build on force_build or version override
            if [ -n "${{ github.event.inputs.version }}" ]; then
              LATEST="${{ github.event.inputs.version }}"
              echo "Using custom version: $LATEST"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "claude-shim", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            elif [ "${{ github.event.inputs.force_build }}" == "true" ]; then
              echo "Force build requested for claude-shim $CURRENT"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "claude-shim", "current": "'$CURRENT'", "latest": "'$CURRENT'"}]')
            else
              echo "claude-shim - no build requested (use force_build or specify version)"
            fi
          fi

          # Check devpod
          if [ -d "recipes/devpod" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "devpod" ]); then
            echo "Checking devpod for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/devpod/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from GitHub releases API
            LATEST=$(curl -s https://api.github.com/repos/skevetter/devpod/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "v\([^"]*\)".*/\1/' || echo "")
            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: devpod $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "devpod", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "devpod is up to date"
            fi
          fi

          # Check ralph-claude-code
          if [ -d "recipes/ralph-claude-code" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "ralph-claude-code" ]); then
            echo "Checking ralph-claude-code for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/ralph-claude-code/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from GitHub releases API
            LATEST=$(curl -s https://api.github.com/repos/frankbria/ralph-claude-code/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "v\([^"]*\)".*/\1/' || echo "")

            # If no releases, fall back to checking tags
            if [ -z "$LATEST" ]; then
              echo "No releases found, checking git tags..."
              LATEST=$(curl -s https://api.github.com/repos/frankbria/ralph-claude-code/tags | jq -r '.[0].name // empty' | sed 's/^v//')
            fi

            # If still no version, use current for force build
            if [ -z "$LATEST" ]; then
              LATEST="$CURRENT"
            fi

            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: ralph-claude-code $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "ralph-claude-code", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "ralph-claude-code is up to date"
            fi
          fi

          # Check iterfzf (PyPI package)
          if [ -d "recipes/iterfzf" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "iterfzf" ]); then
            echo "Checking iterfzf for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/iterfzf/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from PyPI
            LATEST=$(curl -s https://pypi.org/pypi/iterfzf/json | jq -r '.info.version // empty')
            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: iterfzf $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "iterfzf", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "iterfzf is up to date"
            fi
          fi

          # Check devpod-prerelease
          if [ -d "recipes/devpod-prerelease" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "devpod-prerelease" ]); then
            echo "Checking devpod-prerelease for updates..."

            # Get current version from recipe (may have underscores for conda compatibility)
            CURRENT=$(grep -A 3 'package:' recipes/devpod-prerelease/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest prerelease version from GitHub releases API
            # This finds the first prerelease with assets (non-empty assets array)
            LATEST=$(curl -s https://api.github.com/repos/skevetter/devpod/releases | jq -r '[.[] | select(.prerelease == true and (.assets | length) > 0)][0].tag_name // ([.[] | select((.assets | length) > 0)][0].tag_name) // empty' | sed 's/^v//' || echo "")
            echo "Latest prerelease: $LATEST"

            # Normalize versions for comparison (conda uses underscores, GitHub uses hyphens)
            CURRENT_NORMALIZED=$(echo "$CURRENT" | tr '_' '-')
            LATEST_NORMALIZED=$(echo "$LATEST" | tr '-' '_')

            if [ -n "$LATEST" ] && ([ "$CURRENT_NORMALIZED" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: devpod-prerelease $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              # Pass the original GitHub version (with hyphens) - the update script will handle conversion
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "devpod-prerelease", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "devpod-prerelease is up to date"
            fi
          fi

          # Check speedtest-go
          if [ -d "recipes/speedtest-go" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "speedtest-go" ]); then
            echo "Checking speedtest-go for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/speedtest-go/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from GitHub releases API
            LATEST=$(curl -s https://api.github.com/repos/showwin/speedtest-go/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "v\([^"]*\)".*/\1/' || echo "")
            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: speedtest-go $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "speedtest-go", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "speedtest-go is up to date"
            fi
          fi

          # Check pkl
          if [ -d "recipes/pkl" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "pkl" ]); then
            echo "Checking pkl for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/pkl/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from GitHub releases API (pkl uses bare version numbers, no v prefix)
            LATEST=$(curl -s https://api.github.com/repos/apple/pkl/releases/latest | jq -r '.tag_name // empty' || echo "")
            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: pkl $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "pkl", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "pkl is up to date"
            fi
          fi

          # Check ralph-orchestrator
          if [ -d "recipes/ralph-orchestrator" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "ralph-orchestrator" ]); then
            echo "Checking ralph-orchestrator for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/ralph-orchestrator/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from GitHub releases API
            LATEST=$(curl -s https://api.github.com/repos/mikeyobrien/ralph-orchestrator/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "v\([^"]*\)".*/\1/' || echo "")
            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "Update found: ralph-orchestrator $CURRENT -> $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "ralph-orchestrator", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "ralph-orchestrator is up to date"
            fi
          fi

          # Check krill (Rust source build - no releases, uses commit-based versioning)
          if [ -d "recipes/krill" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "krill" ]); then
            echo "Checking krill..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/krill/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # krill is built from source at a specific commit - only build on force_build
            if [ "${{ github.event.inputs.force_build }}" == "true" ]; then
              echo "Force build requested for krill $CURRENT"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "krill", "current": "'$CURRENT'", "latest": "'$CURRENT'"}]')
            else
              echo "krill - no build requested (use force_build to rebuild)"
            fi
          fi

          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Set matrix
        id: set-matrix
        run: |
          UPDATES='${{ steps.check.outputs.updates }}'

          # Define platform configurations with native runners
          # Each platform runs on a runner with matching architecture
          # Note: Intel Mac (osx-64) not supported - macos-13 runners are retired
          PLATFORMS='[
            {"runner": "ubuntu-latest", "platform": "linux-64"},
            {"runner": "ubuntu-24.04-arm", "platform": "linux-aarch64"},
            {"runner": "macos-14", "platform": "osx-arm64"}
          ]'

          # Build the full matrix: each package Ã— each platform
          if [ "$UPDATES" != "[]" ]; then
            # Create combined matrix entries
            MATRIX_INCLUDE=$(echo "$UPDATES" | jq -c --argjson platforms "$PLATFORMS" '
              [.[] as $pkg | $platforms[] as $plat |
                {
                  package: $pkg.package,
                  current: $pkg.current,
                  latest: $pkg.latest,
                  runner: $plat.runner,
                  platform: $plat.platform
                }
              ]
            ')

            echo "matrix={\"include\":$MATRIX_INCLUDE}" >> $GITHUB_OUTPUT
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "packages=$UPDATES" >> $GITHUB_OUTPUT
            echo "Build matrix:"
            echo "$MATRIX_INCLUDE" | jq .
          else
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "packages=[]" >> $GITHUB_OUTPUT
            echo "All packages up to date"
          fi

  # =============================================================================
  # Phase 2: Update recipes (runs once before builds)
  # =============================================================================
  prepare-recipes:
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest

      - name: Update recipes
        run: |
          PACKAGES='${{ needs.check-updates.outputs.packages }}'

          echo "$PACKAGES" | jq -c '.[]' | while read -r pkg; do
            PACKAGE=$(echo "$pkg" | jq -r '.package')
            CURRENT=$(echo "$pkg" | jq -r '.current')
            LATEST=$(echo "$pkg" | jq -r '.latest')

            echo "Updating $PACKAGE from $CURRENT to $LATEST..."

            if [ "$PACKAGE" == "claude-shim" ]; then
              if [ "$CURRENT" != "$LATEST" ]; then
                sed -i 's/version: "'$CURRENT'"/version: "'$LATEST'"/' recipes/claude-shim/recipe.yaml
                echo "Updated claude-shim version to $LATEST"
              else
                echo "claude-shim version unchanged ($CURRENT)"
              fi
            elif [ "$PACKAGE" == "ralph-claude-code" ]; then
              if [ "$CURRENT" != "$LATEST" ]; then
                # Get latest commit hash from main branch
                LATEST_COMMIT=$(curl -s https://api.github.com/repos/frankbria/ralph-claude-code/commits/main | jq -r '.sha')
                echo "Latest commit: $LATEST_COMMIT"

                # Update version
                sed -i 's/version: "'$CURRENT'"/version: "'$LATEST'"/' recipes/ralph-claude-code/recipe.yaml

                # Update git rev
                sed -i "s/rev: .*/rev: $LATEST_COMMIT/" recipes/ralph-claude-code/recipe.yaml

                echo "Updated ralph-claude-code to $LATEST (commit: ${LATEST_COMMIT:0:8})"
              else
                echo "ralph-claude-code version unchanged ($CURRENT)"
              fi
            else
              # Use update script for other packages
              if [ -f "scripts/update-$PACKAGE.py" ]; then
                pixi run python scripts/update-$PACKAGE.py $LATEST
              else
                echo "No update script found for $PACKAGE, skipping recipe update"
              fi
            fi
          done

      - name: Commit recipe updates
        run: |
          if git diff --quiet; then
            echo "No recipe changes to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add recipes/*/recipe.yaml
            git commit -m "chore: update recipes for release [skip ci]"
            git push
            echo "Recipe updates committed"
          fi

  # =============================================================================
  # Phase 3: Build packages on native runners (parallel matrix)
  # =============================================================================
  build:
    needs: [check-updates, prepare-recipes]
    if: needs.check-updates.outputs.has-updates == 'true'
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix: ${{ fromJson(needs.check-updates.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: main  # Get the latest with recipe updates

      - name: Pull latest changes
        run: git pull origin main

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest

      - name: Build ${{ matrix.package }} for ${{ matrix.platform }}
        id: build
        run: |
          echo "Building ${{ matrix.package }} for ${{ matrix.platform }} on ${{ matrix.runner }}..."
          mkdir -p output

          # Build the package
          if pixi run rattler-build build \
            --recipe recipes/${{ matrix.package }}/recipe.yaml \
            --target-platform ${{ matrix.platform }} \
            --output-dir output \
            --channel conda-forge; then
            echo "Build succeeded"
            echo "success=true" >> $GITHUB_OUTPUT

            # List built packages
            echo "Built packages:"
            find output -name "*.conda" -o -name "*.tar.bz2" | head -20
          else
            echo "Build failed for ${{ matrix.platform }}"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload build artifact
        if: steps.build.outputs.success == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: conda-${{ matrix.package }}-${{ matrix.platform }}
          path: output/${{ matrix.platform }}/*.conda
          retention-days: 7

  # =============================================================================
  # Phase 4: Upload all packages to prefix.dev
  # =============================================================================
  upload:
    needs: [check-updates, build]
    if: always() && needs.check-updates.outputs.has-updates == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest

      - name: Download all artifacts
        uses: actions/download-artifact@v8
        with:
          path: artifacts
          pattern: conda-*

      - name: Organize packages
        run: |
          mkdir -p output

          echo "Downloaded artifacts:"
          find artifacts -type f -name "*.conda" | head -50

          # Move all packages to output directory with proper structure
          for pkg in artifacts/conda-*/*.conda; do
            if [ -f "$pkg" ]; then
              # Extract platform from the artifact directory name
              artifact_name=$(dirname "$pkg" | xargs basename)
              platform=$(echo "$artifact_name" | sed 's/conda-[^-]*-//')

              mkdir -p "output/$platform"
              cp "$pkg" "output/$platform/"
              echo "Copied $pkg to output/$platform/"
            fi
          done

          echo ""
          echo "Organized packages:"
          find output -name "*.conda" | sort

      - name: Upload to prefix.dev
        env:
          PIXI_TOKEN: ${{ secrets.PIXI_TOKEN }}
        run: |
          echo "Uploading packages to blooop channel..."

          uploaded=0
          failed=0
          skipped=0

          for pkg in output/*/*.conda; do
            if [ -f "$pkg" ]; then
              echo ""
              echo "Uploading $(basename "$pkg")..."

              if pixi run rattler-build upload prefix \
                --skip-existing \
                --channel blooop \
                --api-key "$PIXI_TOKEN" \
                "$pkg" 2>&1; then
                echo "Upload succeeded"
                uploaded=$((uploaded + 1))
              else
                # Check if it was skipped (already exists)
                if pixi run rattler-build upload prefix \
                  --skip-existing \
                  --channel blooop \
                  --api-key "$PIXI_TOKEN" \
                  "$pkg" 2>&1 | grep -q "already exists"; then
                  echo "Package already exists, skipped"
                  skipped=$((skipped + 1))
                else
                  echo "Upload failed"
                  failed=$((failed + 1))
                fi
              fi
            fi
          done

          echo ""
          echo "========================================="
          echo "Upload Summary:"
          echo "  Uploaded: $uploaded"
          echo "  Skipped:  $skipped"
          echo "  Failed:   $failed"
          echo "========================================="

          if [ "$failed" -gt 0 ]; then
            echo "Some uploads failed"
            exit 1
          fi

      - name: Commit recipe updates
        run: |
          git pull origin main

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add recipes/*/recipe.yaml
            git commit -m "Update package recipes [skip ci]" || echo "Nothing to commit"
            git push || echo "Nothing to push"
          fi

  # =============================================================================
  # Phase 5: Verify packages are available in channel
  # =============================================================================
  verify:
    needs: [check-updates, upload]
    if: always() && needs.upload.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for channel sync
        run: sleep 30

      - name: Verify packages in channel
        run: |
          echo "Verifying packages are available in blooop channel..."

          PACKAGES='${{ needs.check-updates.outputs.packages }}'

          echo "$PACKAGES" | jq -c '.[]' | while read -r pkg; do
            PACKAGE=$(echo "$pkg" | jq -r '.package')
            LATEST=$(echo "$pkg" | jq -r '.latest')

            echo ""
            echo "Checking $PACKAGE $LATEST..."

            for platform in linux-64 linux-aarch64 osx-64 osx-arm64; do
              if curl -sL "https://prefix.dev/blooop/$platform/repodata.json" | grep -q "\"$PACKAGE-$LATEST"; then
                echo "  $platform: available"
              else
                echo "  $platform: NOT FOUND"
              fi
            done
          done
