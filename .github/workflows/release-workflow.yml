name: Release Workflow

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      package:
        description: 'Specific package to update (leave empty for all)'
        required: false
        type: string
      version:
        description: 'Specific version to build (leave empty to use API)'
        required: false
        type: string
      force_build:
        description: 'Force build even if no updates found'
        required: false
        type: boolean
        default: false
      force_overwrite:
        description: 'Force overwrite existing assets on upload'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*'  # Trigger on version tags
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write
  id-token: write  # Required for trusted publishing with OIDC

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-updates: ${{ steps.set-matrix.outputs.has-updates }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest

      - name: Update pixi lock file if needed
        run: |
          echo "ğŸ”’ Checking if pixi.lock is up to date..."
          if ! pixi install --locked 2>&1 | grep -q "up-to-date"; then
            echo "âš ï¸  Lock file out of date, updating..."
            pixi install

            if git diff --quiet pixi.lock; then
              echo "âœ… Lock file is now up to date (no changes needed)"
            else
              echo "ğŸ“ Lock file updated, committing changes..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add pixi.lock
              git commit -m "chore: update pixi.lock file [skip ci]"
              git push
              echo "âœ… Lock file committed and pushed"
            fi
          else
            echo "âœ… Lock file is already up to date"
          fi

      - name: Check for updates
        id: check
        run: |
          # Create array of packages that need updates
          UPDATES="[]"

          # Check claude-code
          if [ -d "recipes/claude-code" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "claude-code" ]); then
            echo "ğŸ” Checking claude-code for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/claude-code/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Use custom version if provided, otherwise fetch latest from API
            if [ -n "${{ github.event.inputs.version }}" ]; then
              LATEST="${{ github.event.inputs.version }}"
              echo "Using custom version: $LATEST"
            else
              LATEST=$(curl -s "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/latest" || echo "")
              echo "Latest version: $LATEST"
            fi

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "ğŸ“¦ Update found: claude-code $CURRENT â†’ $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "claude-code", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "âœ… claude-code is up to date"
            fi
          fi

          # Check devpod
          if [ -d "recipes/devpod" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "devpod" ]); then
            echo "ğŸ” Checking devpod for updates..."

            # Get current version from recipe
            CURRENT=$(grep -A 3 'package:' recipes/devpod/recipe.yaml | grep 'version:' | sed 's/.*version:[[:space:]]*"\([^"]*\)".*/\1/')
            echo "Current version: $CURRENT"

            # Get latest version from GitHub releases API
            LATEST=$(curl -s https://api.github.com/repos/skevetter/devpod/releases/latest | grep '"tag_name"' | sed 's/.*"tag_name": "v\([^"]*\)".*/\1/' || echo "")
            echo "Latest version: $LATEST"

            if [ -n "$LATEST" ] && ([ "$CURRENT" != "$LATEST" ] || [ "${{ github.event.inputs.force_build }}" == "true" ]); then
              echo "ğŸ“¦ Update found: devpod $CURRENT â†’ $LATEST (forced: ${{ github.event.inputs.force_build }})"
              UPDATES=$(echo $UPDATES | jq -c '. + [{"package": "devpod", "current": "'$CURRENT'", "latest": "'$LATEST'"}]')
            else
              echo "âœ… devpod is up to date"
            fi
          fi

          # Add checks for other packages here as you add them...
          # Example:
          # if [ -d "recipes/another-package" ] && ([ -z "${{ github.event.inputs.package }}" ] || [ "${{ github.event.inputs.package }}" == "another-package" ]); then
          #   # Check another-package logic here
          # fi

          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Set matrix
        id: set-matrix
        run: |
          UPDATES='${{ steps.check.outputs.updates }}'
          echo "matrix={\"include\":$UPDATES}" >> $GITHUB_OUTPUT

          if [ "$UPDATES" != "[]" ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Updates found: $UPDATES"
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All packages up to date"
          fi

  update-packages:
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.check-updates.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest

      - name: Update pixi lock file if needed
        run: |
          echo "ğŸ”’ Checking if pixi.lock is up to date..."
          if ! pixi install --locked 2>&1 | grep -q "up-to-date"; then
            echo "âš ï¸  Lock file out of date, updating..."
            pixi install

            if git diff --quiet pixi.lock; then
              echo "âœ… Lock file is now up to date (no changes needed)"
            else
              echo "ğŸ“ Lock file updated, committing changes..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add pixi.lock
              git commit -m "chore: update pixi.lock file [skip ci]"
              git push
              echo "âœ… Lock file committed and pushed"
            fi
          else
            echo "âœ… Lock file is already up to date"
          fi

      - name: Update ${{ matrix.package }} recipe
        run: |
          echo "ğŸ”„ Updating ${{ matrix.package }} from ${{ matrix.current }} to ${{ matrix.latest }}"
          pixi run python scripts/update-${{ matrix.package }}.py ${{ matrix.latest }}

      - name: Build and Upload ${{ matrix.package }}
        env:
          PIXI_TOKEN: ${{ secrets.PIXI_TOKEN }}
        run: |
          mkdir -p output

          # Define platforms to build for
          PLATFORMS=("linux-64" "linux-aarch64")

          echo "ğŸ—ï¸  Building and uploading ${{ matrix.package }} for multiple platforms..."
          echo "Force overwrite: ${{ github.event.inputs.force_overwrite }}"

          failures=0
          for platform in "${PLATFORMS[@]}"; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Processing $platform..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Use force overwrite logic: auto-increment build number on conflicts
            if [ "${{ github.event.inputs.force_overwrite }}" == "true" ]; then
              if ! bash scripts/build-and-upload.sh "${{ matrix.package }}" "$platform" blooop; then
                echo "âš ï¸  Failed to build/upload for $platform"
                failures=$((failures+1))
              fi
            else
              # Normal mode: skip existing packages
              echo "Building for $platform..."
              if pixi run rattler-build build \
                --recipe recipes/${{ matrix.package }}/recipe.yaml \
                --target-platform $platform \
                --output-dir output \
                --channel conda-forge; then

                # Upload with --skip-existing
                for PKG_FILE in output/$platform/*.tar.bz2 output/$platform/*.conda; do
                  [ -f "$PKG_FILE" ] || continue
                  echo "ğŸ“¤ Uploading $(basename "$PKG_FILE") (skip-existing mode)..."

                  if pixi run rattler-build upload prefix --verbose --skip-existing --channel blooop "$PKG_FILE"; then
                    echo "âœ… Upload succeeded"
                  elif [ -n "${PIXI_TOKEN:-}" ]; then
                    echo "ğŸ”‘ Retrying with PIXI_TOKEN..."
                    if pixi run rattler-build upload prefix --verbose --skip-existing --channel blooop --api-key "$PIXI_TOKEN" "$PKG_FILE"; then
                      echo "âœ… Upload succeeded with token"
                    else
                      echo "âš ï¸  Upload failed (package may already exist)"
                    fi
                  fi
                done
              else
                echo "âš ï¸  Skipping $platform (build failed or not supported)"
                failures=$((failures+1))
              fi
            fi
          done

          # List all built packages
          echo ""
          echo "ğŸ“¦ All built packages:"
          find output -name "*.conda" -o -name "*.tar.bz2" | sort

          if [ "$failures" -gt 0 ]; then
            echo "âš ï¸  Some platforms failed"
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: conda-packages-${{ matrix.package }}-${{ matrix.latest }}
          path: output/
          retention-days: 30

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "âœ… No changes to commit"
          else
            echo "ğŸ“ Committing updates for ${{ matrix.package }} ${{ matrix.latest }}"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add recipes/${{ matrix.package }}/recipe.yaml
            git commit -m "$(cat <<'EOF'
          Update ${{ matrix.package }} to ${{ matrix.latest }} [skip ci]

          - Updated package version from ${{ matrix.current }} to ${{ matrix.latest }}
          - Updated source checksums for all platforms
          - Reset build number to 0
          - Built and uploaded packages to https://prefix.dev/channels/blooop

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
          EOF
          )"
            git push
            echo "âœ… Changes committed and pushed to main"
          fi
